/*	MikMod Web Audio library v0.0.1
	(c) 2021 Carlos Rafael Gimenes das Neves.

	https://github.com/sezero/mikmod
	https://github.com/carlosrafaelgn/mikmod/tree/master/libmikmod/webaudio

	This library is free software; you can redistribute it and/or modify
	it under the terms of the GNU Library General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Library General Public License for more details.

	You should have received a copy of the GNU Library General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
	02111-1307, USA.
*/
"use strict";var __awaiter=this&&this.__awaiter||function(a,b,e,k){function f(h){return h instanceof e?h:new e(function(g){g(h)})}return new (e||(e=Promise))(function(h,g){function d(l){try{c(k.next(l))}catch(n){g(n)}}function m(l){try{c(k["throw"](l))}catch(n){g(n)}}function c(l){l.done?h(l.value):f(l.value).then(d,m)}c((k=k.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function e(c){return function(l){return k([c,l])}}function k(c){if(h)throw new TypeError("Generator is already executing.");
for(;f;)try{if(h=1,g&&(d=c[0]&2?g["return"]:c[0]?g["throw"]||((d=g["return"])&&d.call(g),0):g.next)&&!(d=d.call(g,c[1])).done)return d;if(g=0,d)c=[c[0]&2,d.value];switch(c[0]){case 0:case 1:d=c;break;case 4:return f.label++,{value:c[1],done:!1};case 5:f.label++;g=c[1];c=[0];continue;case 7:c=f.ops.pop();f.trys.pop();continue;default:if(!(d=f.trys,d=0<d.length&&d[d.length-1])&&(6===c[0]||2===c[0])){f=0;continue}if(3===c[0]&&(!d||c[1]>d[0]&&c[1]<d[3]))f.label=c[1];else if(6===c[0]&&f.label<d[1])f.label=
d[1],d=c;else if(d&&f.label<d[2])f.label=d[2],f.ops.push(c);else{d[2]&&f.ops.pop();f.trys.pop();continue}}c=b.call(a,f)}catch(l){c=[6,l],g=0}finally{h=d=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var f={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},h,g,d,m;return m={next:e(0),"throw":e(1),"return":e(2)},"function"===typeof Symbol&&(m[Symbol.iterator]=function(){return this}),m},LibMikModMessageId;
(function(a){a[a.INIT=1]="INIT";a[a.LOAD_MODULE_BUFFER=2]="LOAD_MODULE_BUFFER";a[a.CHANGE_GENERAL_OPTIONS=3]="CHANGE_GENERAL_OPTIONS";a[a.STOP_MODULE=4]="STOP_MODULE";a[a.PLAYBACK_ERROR=5]="PLAYBACK_ERROR";a[a.PLAYBACK_ENDED=6]="PLAYBACK_ENDED"})(LibMikModMessageId||(LibMikModMessageId={}));
var LibMikMod=function(){function a(){}a.isSupported=function(){return"AudioWorklet"in window&&"AudioWorkletNode"in window&&"WebAssembly"in window};a.init=function(b,e){return __awaiter(this,void 0,void 0,function(){var k,f;return __generator(this,function(h){switch(h.label){case 0:if(a.initialized||a.initializing||a.initializationError)return[2];e?e.endsWith("/")||(e+="/"):e="";a.initializing=!0;a.currentId=0;h.label=1;case 1:return h.trys.push([1,,6,7]),[4,fetch(e+"libmikmodclib.wasm?"+a.WEB_VERSION)];
case 2:return k=h.sent(),[4,k.arrayBuffer()];case 3:return f=h.sent(),[4,b.audioWorklet.addModule(e+"libmikmodprocessor.min.js?"+a.WEB_VERSION)];case 4:return h.sent(),[4,new Promise(function(g,d){var m=new AudioWorkletNode(b,"libmikmodprocessor");m.port.onmessage=function(c){(c=c.data)&&c.messageId===LibMikModMessageId.INIT&&a.initializing&&!a.currentId&&(c.errorStr?d(c.errorStr):(a.LIB_VERSION=(c.id>>>16&255)+"."+(c.id>>>8&255)+"."+(c.id&255),g()))};m.onprocessorerror=function(c){d(c)};a.audioNode=
m;a.postMessage({id:a.currentId,messageId:LibMikModMessageId.INIT,buffer:f})})];case 5:return h.sent(),a.initialized=!0,[3,7];case 6:return a.initialized||(a.initializationError=!0),a.initializing=!1,a.stopModule(),[7];case 7:return[2]}})})};a.postMessage=function(b){a.audioNode&&(b.buffer?a.audioNode.port.postMessage(b,[b.buffer]):a.audioNode.port.postMessage(b))};a.loadModule=function(b){if(!a.initialized)throw Error("Library not initialized");if(!b)throw Error("Null options");if(!b.audioContext)throw Error("Null audioContext");
var e=b.source;if(!e)throw Error("Null source");a.stopModule();var k=new AudioWorkletNode(b.audioContext,"libmikmodprocessor");a.currentId++;k.port.onmessage=a.handleResponse;k.onprocessorerror=a.notifyProcessorError;a.audioNode=k;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.onload=b.onload;a.onerror=b.onerror;a.onended=b.onended;var f=a.currentId,h={hqMixer:b.hqMixer,wrap:b.wrap,loop:b.loop,fadeout:b.fadeout,reverb:b.reverb,interpolation:b.interpolation,noiseReduction:b.noiseReduction};
if("lastModified"in e)if("arrayBuffer"in e)e.arrayBuffer().then(function(d){f===a.currentId&&a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:d,options:h})},function(d){f===a.currentId&&a.notifyReaderError(d)});else{var g=new FileReader;g.onerror=function(d){f===a.currentId&&a.notifyReaderError(d)};g.onload=function(){f===a.currentId&&(g.result?a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:g.result,options:h}):a.notifyReaderError("Empty reader result"))};
g.readAsArrayBuffer(e)}else a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:e,options:h})};a.changeGeneralOptions=function(b){if(!a.initialized)throw Error("Library not initialized");a.postMessage({id:a.currentId,messageId:LibMikModMessageId.CHANGE_GENERAL_OPTIONS,options:b})};a.cleanUp=function(){a.currentId++;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.audioNode=null;a.onload=null;a.onerror=null;a.onended=null};a.stopModule=function(){a.audioNode&&
(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.STOP_MODULE}),a.cleanUp())};a.notifyReaderError=function(b){a.notifyError(a.ERROR_FILE_READ,b)};a.notifyProcessorError=function(b){a.notifyError(a.ERROR_PLAYBACK,b)};a.notifyError=function(b,e){if(a.audioNode){var k=a.onerror;a.cleanUp();k&&k(b,e)}};a.notifyEnded=function(){if(a.audioNode){var b=a.onended;a.cleanUp();b&&b()}};a.handleResponse=function(b){var e;if(b=b.data)switch(b.messageId){case LibMikModMessageId.LOAD_MODULE_BUFFER:if(b.id!==
a.currentId||!a.audioNode)break;if(b.errorCode)a.notifyError(a.ERROR_MODULE_LOAD,b.errorStr||b.errorCode.toString());else if(a.infoSongName=b.infoSongName||null,a.infoModType=b.infoModType||null,a.infoComment=b.infoComment||null,a.onload)a.onload(a.audioNode);break;case LibMikModMessageId.PLAYBACK_ERROR:if(b.id!==a.currentId)break;a.notifyProcessorError(b.errorStr||(null===(e=b.errorCode)||void 0===e?void 0:e.toString()));break;case LibMikModMessageId.PLAYBACK_ENDED:b.id===a.currentId&&a.notifyEnded()}};
a.WEB_VERSION=1;a.LIB_VERSION=null;a.ERROR_FILE_READ=1;a.ERROR_MODULE_LOAD=2;a.ERROR_PLAYBACK=3;a.initialized=!1;a.initializing=!1;a.initializationError=!1;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.currentId=0;a.audioNode=null;a.onload=null;a.onerror=null;a.onended=null;return a}();
