/*	MikMod Web Audio library v0.0.1
	(c) 2021 Carlos Rafael Gimenes das Neves.

	https://github.com/sezero/mikmod
	https://github.com/carlosrafaelgn/mikmod/tree/master/libmikmod/webaudio

	This library is free software; you can redistribute it and/or modify
	it under the terms of the GNU Library General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Library General Public License for more details.

	You should have received a copy of the GNU Library General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
	02111-1307, USA.
*/
"use strict";var __awaiter=this&&this.__awaiter||function(a,b,e,k){function f(h){return h instanceof e?h:new e(function(g){g(h)})}return new (e||(e=Promise))(function(h,g){function c(l){try{d(k.next(l))}catch(n){g(n)}}function m(l){try{d(k["throw"](l))}catch(n){g(n)}}function d(l){l.done?h(l.value):f(l.value).then(c,m)}d((k=k.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function e(d){return function(l){return k([d,l])}}function k(d){if(h)throw new TypeError("Generator is already executing.");
for(;f;)try{if(h=1,g&&(c=d[0]&2?g["return"]:d[0]?g["throw"]||((c=g["return"])&&c.call(g),0):g.next)&&!(c=c.call(g,d[1])).done)return c;if(g=0,c)d=[d[0]&2,c.value];switch(d[0]){case 0:case 1:c=d;break;case 4:return f.label++,{value:d[1],done:!1};case 5:f.label++;g=d[1];d=[0];continue;case 7:d=f.ops.pop();f.trys.pop();continue;default:if(!(c=f.trys,c=0<c.length&&c[c.length-1])&&(6===d[0]||2===d[0])){f=0;continue}if(3===d[0]&&(!c||d[1]>c[0]&&d[1]<c[3]))f.label=d[1];else if(6===d[0]&&f.label<c[1])f.label=
c[1],c=d;else if(c&&f.label<c[2])f.label=c[2],f.ops.push(d);else{c[2]&&f.ops.pop();f.trys.pop();continue}}d=b.call(a,f)}catch(l){d=[6,l],g=0}finally{h=c=0}if(d[0]&5)throw d[1];return{value:d[0]?d[1]:void 0,done:!0}}var f={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},h,g,c,m;return m={next:e(0),"throw":e(1),"return":e(2)},"function"===typeof Symbol&&(m[Symbol.iterator]=function(){return this}),m},LibMikModMessageId;
(function(a){a[a.INIT=1]="INIT";a[a.CHECK_STATUS=2]="CHECK_STATUS";a[a.LOAD_MODULE_BUFFER=3]="LOAD_MODULE_BUFFER";a[a.CHANGE_GENERAL_OPTIONS=4]="CHANGE_GENERAL_OPTIONS";a[a.STOP_MODULE=5]="STOP_MODULE";a[a.PLAYBACK_ERROR=6]="PLAYBACK_ERROR";a[a.PLAYBACK_ENDED=7]="PLAYBACK_ENDED";a[a.GET_ID=8]="GET_ID"})(LibMikModMessageId||(LibMikModMessageId={}));
var LibMikMod=function(){function a(){}a.isSupported=function(){return"AudioWorklet"in window&&"AudioWorkletNode"in window&&"WebAssembly"in window};a.init=function(b,e){return __awaiter(this,void 0,void 0,function(){var k,f;return __generator(this,function(h){switch(h.label){case 0:if(a.initialized)return[2];e?e.endsWith("/")||(e+="/"):e="";a.initialized=!0;return[4,fetch(e+"libmikmodclib.wasm?"+a.VERSION)];case 1:return k=h.sent(),f=a,[4,k.arrayBuffer()];case 2:return f.wasmBuffer=h.sent(),[2,b.audioWorklet.addModule(e+
"libmikmodprocessor.min.js?"+a.VERSION)]}})})};a.postMessage=function(b){a.audioNode&&(b.buffer?a.audioNode.port.postMessage(b,[b.buffer]):a.audioNode.port.postMessage(b))};a.loadModule=function(b,e,k,f,h,g){if(a.loading)throw Error("Still loading");if(a.loadError)throw Error("Error loading the library");if(!e)throw Error("Null source");b=new AudioWorkletNode(b,"libmikmodprocessor");b.port.onmessage=a.handleResponse;b.onprocessorerror=a.notifyProcessorError;a.audioNode=b;a.infoSongName=null;a.infoModType=
null;a.infoComment=null;a.onload=k;a.onerror=f;a.onended=h;a.loadOptions=g;a.loading=!0;if("lastModified"in e)if("arrayBuffer"in e)e.arrayBuffer().then(a.startLoadingModule,a.notifyReaderError);else{var c=new FileReader;c.onerror=a.notifyReaderError;c.onload=function(){c.result?a.startLoadingModule(c.result):a.notifyReaderError()};c.readAsArrayBuffer(e)}else a.startLoadingModule(e)};a.startLoadingModule=function(b){a.srcBuffer=b;a.postMessage({id:a.currentId,messageId:LibMikModMessageId.GET_ID})};
a.finishLoadingModule=function(){a.loaded?a.srcBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:a.srcBuffer,options:a.loadOptions}),a.srcBuffer=null,a.loadOptions=null):a.notifyError(a.ERROR_MODULE_LOAD,"Null srcBuffer"):a.wasmBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.INIT,buffer:a.wasmBuffer}),a.wasmBuffer=null):a.notifyError(a.ERROR_INITIALIZE,"Null wasmBuffer")};a.changeGeneralOptions=function(b){a.postMessage({id:a.currentId,
messageId:LibMikModMessageId.CHANGE_GENERAL_OPTIONS,options:b})};a.stopModule=function(){a.audioNode&&(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.STOP_MODULE}),a.currentId=0,a.audioNode=null,a.srcBuffer=null,a.onload=null,a.onerror=null,a.onended=null)};a.notifyReaderError=function(b){a.notifyError(a.ERROR_FILE_READ,b)};a.notifyProcessorError=function(b){a.notifyError(a.ERROR_PLAYBACK,b)};a.notifyError=function(b,e){if(a.audioNode){a.loading=!1;a.currentId=0;a.audioNode=null;a.srcBuffer=
null;var k=a.onerror;a.onload=null;a.onerror=null;a.onended=null;k&&k(b,e)}};a.notifyEnded=function(){if(a.audioNode){a.currentId=0;a.audioNode=null;a.srcBuffer=null;var b=a.onended;a.onload=null;a.onerror=null;a.onended=null;b&&b()}};a.handleResponse=function(b){var e;if(b=b.data)switch(b.messageId){case LibMikModMessageId.INIT:a.loading&&a.postMessage({id:a.currentId,messageId:LibMikModMessageId.CHECK_STATUS});break;case LibMikModMessageId.CHECK_STATUS:if(b.id!==a.currentId)break;b.loading?setTimeout(function(){a.postMessage({id:a.currentId,
messageId:LibMikModMessageId.CHECK_STATUS})},10):b.loaded?(a.loaded=!0,a.srcBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:a.srcBuffer,options:a.loadOptions}),a.srcBuffer=null,a.loadOptions=null):a.loading=!1):(a.loading=!1,a.loadError=!0,a.notifyError(a.ERROR_INITIALIZE));break;case LibMikModMessageId.LOAD_MODULE_BUFFER:if(b.id!==a.currentId)break;a.loading=!1;a.onload&&a.onerror&&a.audioNode&&(b.errorCode?a.notifyError(a.ERROR_MODULE_LOAD,b.errorStr||
b.errorCode.toString()):(a.infoSongName=b.infoSongName||null,a.infoModType=b.infoModType||null,a.infoComment=b.infoComment||null,a.onload(a.audioNode)));break;case LibMikModMessageId.PLAYBACK_ERROR:if(b.id!==a.currentId)break;a.notifyProcessorError(b.errorStr||(null===(e=b.errorCode)||void 0===e?void 0:e.toString()));break;case LibMikModMessageId.PLAYBACK_ENDED:if(b.id!==a.currentId)break;a.notifyEnded();break;case LibMikModMessageId.GET_ID:a.currentId=b.id,a.finishLoadingModule()}};a.VERSION=1;a.ERROR_INITIALIZE=
1;a.ERROR_FILE_READ=2;a.ERROR_MODULE_LOAD=3;a.ERROR_PLAYBACK=4;a.initialized=!1;a.loading=!1;a.loaded=!1;a.loadError=!1;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.currentId=0;a.audioNode=null;a.wasmBuffer=null;a.srcBuffer=null;a.loadOptions=null;a.onload=null;a.onerror=null;a.onended=null;return a}();
