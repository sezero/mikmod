var __awaiter=this&&this.__awaiter||function(a,b,f,k){function e(h){return h instanceof f?h:new f(function(g){g(h)})}return new (f||(f=Promise))(function(h,g){function d(l){try{c(k.next(l))}catch(n){g(n)}}function m(l){try{c(k["throw"](l))}catch(n){g(n)}}function c(l){l.done?h(l.value):e(l.value).then(d,m)}c((k=k.apply(a,b||[])).next())})},__generator=this&&this.__generator||function(a,b){function f(c){return function(l){return k([c,l])}}function k(c){if(h)throw new TypeError("Generator is already executing.");
for(;e;)try{if(h=1,g&&(d=c[0]&2?g["return"]:c[0]?g["throw"]||((d=g["return"])&&d.call(g),0):g.next)&&!(d=d.call(g,c[1])).done)return d;if(g=0,d)c=[c[0]&2,d.value];switch(c[0]){case 0:case 1:d=c;break;case 4:return e.label++,{value:c[1],done:!1};case 5:e.label++;g=c[1];c=[0];continue;case 7:c=e.ops.pop();e.trys.pop();continue;default:if(!(d=e.trys,d=0<d.length&&d[d.length-1])&&(6===c[0]||2===c[0])){e=0;continue}if(3===c[0]&&(!d||c[1]>d[0]&&c[1]<d[3]))e.label=c[1];else if(6===c[0]&&e.label<d[1])e.label=
d[1],d=c;else if(d&&e.label<d[2])e.label=d[2],e.ops.push(c);else{d[2]&&e.ops.pop();e.trys.pop();continue}}c=b.call(a,e)}catch(l){c=[6,l],g=0}finally{h=d=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}var e={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},h,g,d,m;return m={next:f(0),"throw":f(1),"return":f(2)},"function"===typeof Symbol&&(m[Symbol.iterator]=function(){return this}),m},LibMikModMessageId;
(function(a){a[a.INIT=1]="INIT";a[a.CHECK_STATUS=2]="CHECK_STATUS";a[a.LOAD_MODULE_BUFFER=3]="LOAD_MODULE_BUFFER";a[a.CHANGE_GENERAL_OPTIONS=4]="CHANGE_GENERAL_OPTIONS";a[a.STOP_MODULE=5]="STOP_MODULE";a[a.PLAYBACK_ENDED=6]="PLAYBACK_ENDED";a[a.GET_ID=7]="GET_ID"})(LibMikModMessageId||(LibMikModMessageId={}));
var LibMikModAudioNode=function(){function a(){}a.isSupported=function(){return"AudioWorkletNode"in window&&"WebAssembly"in window};a.init=function(b,f){return __awaiter(this,void 0,void 0,function(){var k,e;return __generator(this,function(h){switch(h.label){case 0:if(a.initialized)return[2];f?f.endsWith("/")||(f+="/"):f="";a.initialized=!0;return[4,fetch(f+"libmikmodclib.wasm")];case 1:return k=h.sent(),e=a,[4,k.arrayBuffer()];case 2:return e.wasmBuffer=h.sent(),[2,b.audioWorklet.addModule(f+"libmikmodprocessor.min.js")]}})})};
a.postMessage=function(b){a.audioNode&&(b.buffer?a.audioNode.port.postMessage(b,[b.buffer]):a.audioNode.port.postMessage(b))};a.loadModule=function(b,f,k,e,h,g){if(a.loading)throw Error("Still loading");if(a.loadError)throw Error("Error loading the library");if(!f)throw Error("Null buffer");b=new AudioWorkletNode(b,"libmikmodprocessor");b.port.onmessage=a.handleResponse;b.onprocessorerror=a.notifyError;a.audioNode=b;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.srcBuffer=f;a.onload=
k;a.onerror=e;a.onended=h;a.loadOptions=g;a.loading=!0;a.postMessage({id:a.currentId,messageId:LibMikModMessageId.GET_ID})};a.finishLoadingModule=function(){a.loaded?a.srcBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:a.srcBuffer,options:a.loadOptions}),a.srcBuffer=null,a.loadOptions=null):this.notifyError("Null srcBuffer"):a.wasmBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.INIT,buffer:a.wasmBuffer}),a.wasmBuffer=null):this.notifyError("Null wasmBuffer")};
a.changeGeneralOptions=function(b){a.postMessage({id:a.currentId,messageId:LibMikModMessageId.CHANGE_GENERAL_OPTIONS,options:b})};a.stopModule=function(){a.audioNode&&(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.STOP_MODULE}),a.currentId=0,a.audioNode=null,a.srcBuffer=null,a.onload=null,a.onerror=null,a.onended=null)};a.notifyError=function(b){if(a.audioNode){a.currentId=0;a.audioNode=null;a.srcBuffer=null;var f=a.onerror;a.onload=null;a.onerror=null;a.onended=null;f&&f(b)}};a.notifyEnded=
function(){if(a.audioNode){a.currentId=0;a.audioNode=null;a.srcBuffer=null;var b=a.onended;a.onload=null;a.onerror=null;a.onended=null;b&&b()}};a.handleResponse=function(b){if(b=b.data)switch(b.messageId){case LibMikModMessageId.INIT:a.loading&&a.postMessage({id:a.currentId,messageId:LibMikModMessageId.CHECK_STATUS});break;case LibMikModMessageId.CHECK_STATUS:if(b.id!==a.currentId)break;b.loading?setTimeout(function(){a.postMessage({id:a.currentId,messageId:LibMikModMessageId.CHECK_STATUS})},10):
b.loaded?(a.loaded=!0,a.srcBuffer?(a.postMessage({id:a.currentId,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,buffer:a.srcBuffer,options:a.loadOptions}),a.srcBuffer=null,a.loadOptions=null):a.loading=!1):(a.loading=!1,a.loadError=!0,a.notifyError());break;case LibMikModMessageId.LOAD_MODULE_BUFFER:if(b.id!==a.currentId)break;a.loading=!1;a.onload&&a.onerror&&a.audioNode&&(b.result?a.notifyError(b.result):(a.infoSongName=b.infoSongName||null,a.infoModType=b.infoModType||null,a.infoComment=b.infoComment||
null,a.onload(a.audioNode)));break;case LibMikModMessageId.PLAYBACK_ENDED:if(b.id!==a.currentId)break;a.notifyEnded();break;case LibMikModMessageId.GET_ID:a.currentId=b.id,a.finishLoadingModule()}};a.initialized=!1;a.loading=!1;a.loaded=!1;a.loadError=!1;a.infoSongName=null;a.infoModType=null;a.infoComment=null;a.currentId=0;a.audioNode=null;a.wasmBuffer=null;a.srcBuffer=null;a.loadOptions=null;a.onload=null;a.onerror=null;a.onended=null;return a}();
