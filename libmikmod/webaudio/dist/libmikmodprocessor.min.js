/*	MikMod Web Audio library v0.0.1
	(c) 2021 Carlos Rafael Gimenes das Neves.

	https://github.com/sezero/mikmod
	https://github.com/carlosrafaelgn/mikmod/tree/master/libmikmod/webaudio

	This library is free software; you can redistribute it and/or modify
	it under the terms of the GNU Library General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Library General Public License for more details.

	You should have received a copy of the GNU Library General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
	02111-1307, USA.
*/
"use strict";var LibMikModMessageId;(function(b){b[b.INIT=1]="INIT";b[b.LOAD_MODULE_BUFFER=2]="LOAD_MODULE_BUFFER";b[b.CHANGE_GENERAL_OPTIONS=3]="CHANGE_GENERAL_OPTIONS";b[b.STOP_MODULE=4]="STOP_MODULE";b[b.PLAYBACK_ERROR=5]="PLAYBACK_ERROR";b[b.PLAYBACK_ENDED=6]="PLAYBACK_ENDED"})(LibMikModMessageId||(LibMikModMessageId={}));
class LibMikMod{static init(b){return LibMikMod.loaded?Promise.resolve():new Promise((c,g)=>{LibMikMod.loading?g(LibMikMod.loadErrorStr="The library was still loading"):LibMikMod.loadErrorStr?g(LibMikMod.loadErrorStr):(LibMikMod.loading=!0,LibMikModCLib({wasmBinary:b}).then(f=>{LibMikMod.cLib=f;(f=f._init())?(LibMikMod.loading=!1,g(LibMikMod.loadErrorStr=LibMikMod.getStrerr(f))):(LibMikMod.loading=!1,LibMikMod.loaded=!0,LibMikMod.loadErrorStr=null,c())},f=>{LibMikMod.loading=!1;g(LibMikMod.loadErrorStr=
(f?f.message||f.toString():null)||"Unknown error while loading the library")}))})}static terminate(){LibMikMod.cLib&&(LibMikMod.cLib._terminate(),LibMikMod.cLib=null,LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static getVersion(){return LibMikMod.cLib?LibMikMod.cLib._getVersion():0}static loadModule(b,c,g){if(!LibMikMod.cLib)return 3;if(!c)return 2;var f=LibMikMod.cLib._preLoadModule(c.byteLength);if(!f)return 2;f=new Uint8Array(LibMikMod.cLib.HEAP8.buffer,f,c.byteLength);"set"in
c?f.set(c,0):f.set(new Uint8Array(c,0,c.byteLength),0);LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;g&&(void 0!==g.reverb&&0<=g.reverb&&15>=g.reverb&&(LibMikMod.lastReverb=g.reverb),void 0!==g.hqMixer&&(LibMikMod.lastHqMixer=g.hqMixer?1:0),void 0!==g.interpolation&&(LibMikMod.lastInterpolation=g.interpolation?1:0),void 0!==g.noiseReduction&&(LibMikMod.lastNoiseReduction=g.noiseReduction?1:0),void 0!==g.wrap&&(LibMikMod.lastWrap=g.wrap?1:0),void 0!==g.loop&&(LibMikMod.lastLoop=g.loop?
1:0),void 0!==g.fadeout&&(LibMikMod.lastFadeout=g.fadeout?1:0));return(b=LibMikMod.cLib._loadModule(b,LibMikMod.lastReverb,LibMikMod.lastHqMixer,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction,LibMikMod.lastWrap,LibMikMod.lastLoop,LibMikMod.lastFadeout))||LibMikMod.cLib._getAudioBuffer()?b:2}static changeGeneralOptions(b){b&&(void 0!==b.reverb&&0<=b.reverb&&15>=b.reverb&&(LibMikMod.lastReverb=b.reverb),void 0!==b.interpolation&&(LibMikMod.lastInterpolation=b.interpolation?1:0),void 0!==b.noiseReduction&&
(LibMikMod.lastNoiseReduction=b.noiseReduction?1:0),LibMikMod.cLib&&LibMikMod.cLib._changeGeneralOptions(LibMikMod.lastReverb,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction))}static stopModule(){LibMikMod.cLib&&(LibMikMod.cLib._freeModule(),LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static getString(b){if(LibMikMod.cLib&&b){const g=LibMikMod.cLib.HEAP8;let f=0;for(var c=b;g[c]&&1024>f;c++)f++;if(!f)return"";for(c=Array(f);0<f--;)c[f]=g[b+f];return String.fromCharCode.apply(String,
c)}return null}static getSongName(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getSongName()):null}static getModType(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getModType()):null}static getComment(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getComment()):null}static getErrno(){return LibMikMod.cLib?LibMikMod.cLib._getErrno():0}static getStrerr(b){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getStrerr(b)):null}static process(b){if(!LibMikMod.cLib)return!1;
let c=LibMikMod.audioBufferUsedLength;if(!c){for(var g=0;3>g;g++){c=LibMikMod.cLib._update();if(0>c)return!1;if(c){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=c;break}}if(!c)return!0}var f=null;for(g=b.length-1;0<=g;g--){const w=b[g];for(let x=w.length-1;0<=x;x--){const y=w[x];if(!f){var n=y.length<<2;if(c>=n)c=n,f=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,c>>2),LibMikMod.audioBufferPtr+=c,LibMikMod.audioBufferUsedLength-=c;
else{LibMikMod.tmpBuffer&&LibMikMod.tmpBuffer.byteLength===n||(LibMikMod.tmpBuffer=new Float32Array(y.length));n=c>>2;f=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,n);LibMikMod.audioBufferPtr=0;c=LibMikMod.audioBufferUsedLength=0;LibMikMod.tmpBuffer.set(f);let u=y.length-n;for(;0<u;){if(!c){for(f=0;3>f;f++){c=LibMikMod.cLib._update();if(0>c){if(LibMikMod.getErrno())return!1;c=0;break}if(c){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=
c;break}}if(!c){LibMikMod.tmpBuffer.fill(0,n);break}}let p=u<<2;p>c&&(p=c);const a=p>>2;f=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,a);LibMikMod.audioBufferPtr+=p;LibMikMod.audioBufferUsedLength-=p;LibMikMod.tmpBuffer.set(f,n);n+=a;u-=a}f=LibMikMod.tmpBuffer}}y.set(f)}}return!0}}LibMikMod.cLib=null;LibMikMod.tmpBuffer=null;LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;LibMikMod.lastReverb=0;LibMikMod.lastHqMixer=1;LibMikMod.lastInterpolation=1;
LibMikMod.lastNoiseReduction=1;LibMikMod.lastWrap=0;LibMikMod.lastLoop=0;LibMikMod.lastFadeout=1;LibMikMod.loading=!1;LibMikMod.loaded=!1;LibMikMod.loadErrorStr=null;
class LibMikModProcessor extends AudioWorkletProcessor{constructor(){super();this.id=0;this.ended=!1;this.port.onmessage=this.handleMessage.bind(this)}postResponse(b){this.port&&this.port.postMessage(b)}handleMessage(b){if(b=b.data)switch(b.messageId){case LibMikModMessageId.INIT:if(b.id||this.id||LibMikMod.loaded||LibMikMod.loading||LibMikMod.loadErrorStr||!b.buffer)break;LibMikMod.init(b.buffer).then(()=>{this.ended=!0;this.id=-1;this.postResponse({id:LibMikMod.getVersion(),messageId:LibMikModMessageId.INIT})},
()=>{this.ended=!0;this.id=-1;this.postResponse({id:0,messageId:LibMikModMessageId.INIT,errorCode:-1,errorStr:LibMikMod.loadErrorStr})});break;case LibMikModMessageId.LOAD_MODULE_BUFFER:if(!b.id||this.id)break;this.id=b.id;const c=LibMikMod.loadModule(sampleRate,b.buffer,b.options);c?(this.ended=!0,this.id=-1,LibMikMod.stopModule(),this.postResponse({id:b.id,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,errorCode:c,errorStr:LibMikMod.getStrerr(c)})):this.postResponse({id:this.id,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,
infoSongName:LibMikMod.getSongName(),infoModType:LibMikMod.getModType(),infoComment:LibMikMod.getComment()});break;case LibMikModMessageId.CHANGE_GENERAL_OPTIONS:if(b.id!==this.id)break;LibMikMod.changeGeneralOptions(b.options);break;case LibMikModMessageId.STOP_MODULE:b.id===this.id&&(this.ended=!0,this.id=-1,LibMikMod.stopModule())}}process(b,c,g){return this.ended?!1:LibMikMod.process(c)?!0:(this.ended||(b=this.id,c=LibMikMod.getErrno(),this.ended=!0,this.id=-1,LibMikMod.stopModule(),c?this.postResponse({id:b,
messageId:LibMikModMessageId.PLAYBACK_ERROR,errorCode:c,errorStr:LibMikMod.getStrerr(c)}):this.postResponse({id:b,messageId:LibMikModMessageId.PLAYBACK_ENDED})),!1)}}registerProcessor("libmikmodprocessor",LibMikModProcessor);
var LibMikModCLib=function(){var b="undefined"!==typeof document&&document.currentScript?document.currentScript.src:void 0;return function(c){function g(d){return a.locateFile?a.locateFile(d,q):q+d}function f(d,e){0<d%e&&(d+=e-d%e);return d}function n(d){M=d;a.HEAP8=new Int8Array(d);a.HEAP16=new Int16Array(d);a.HEAP32=new Int32Array(d);a.HEAPU8=G=new Uint8Array(d);a.HEAPU16=new Uint16Array(d);a.HEAPU32=new Uint32Array(d);a.HEAPF32=new Float32Array(d);a.HEAPF64=new Float64Array(d)}function w(d){if(a.onAbort)a.onAbort(d);
d+="";z(d);N=!0;d=new WebAssembly.RuntimeError("abort("+d+"). Build with -s ASSERTIONS=1 for more info.");H(d);throw d;}function x(d){try{if(d==m&&A)return new Uint8Array(A);if(I)return I(d);throw"both async and sync fetching of the wasm failed";}catch(e){w(e)}}function y(){if(!A&&(J||B)){if("function"===typeof fetch&&!m.startsWith("file://"))return fetch(m,{credentials:"same-origin"}).then(function(d){if(!d.ok)throw"failed to load wasm binary file at '"+m+"'";return d.arrayBuffer()}).catch(function(){return x(m)});
if(O)return new Promise(function(d,e){O(m,function(k){d(new Uint8Array(k))},e)})}return Promise.resolve().then(function(){return x(m)})}function u(d){for(;0<d.length;){var e=d.shift();if("function"==typeof e)e(a);else{var k=e.func;"number"===typeof k?void 0===e.arg?K.get(k)():K.get(k)(e.arg):k(void 0===e.arg?null:e.arg)}}}function p(d){function e(){if(!E&&(E=!0,a.calledRun=!0,!N)){u(P);Q(a);if(a.onRuntimeInitialized)a.onRuntimeInitialized();if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=
[a.postRun]);a.postRun.length;)R.unshift(a.postRun.shift());u(R)}}if(!(0<v)){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)S.unshift(a.preRun.shift());u(S);0<v||(a.setStatus?(a.setStatus("Running..."),setTimeout(function(){setTimeout(function(){a.setStatus("")},1);e()},1)):e())}}c=c||{};var a="undefined"!==typeof c?c:{},Q,H;a.ready=new Promise(function(d,e){Q=d;H=e});var C={},r;for(r in a)a.hasOwnProperty(r)&&(C[r]=a[r]);var J=!1,B=!1;J="object"===typeof window;
B="function"===typeof importScripts;var q="",I;if(J||B){B?q=self.location.href:"undefined"!==typeof document&&document.currentScript&&(q=document.currentScript.src);b&&(q=b);q=0!==q.indexOf("blob:")?q.substr(0,q.lastIndexOf("/")+1):"";B&&(I=function(d){var e=new XMLHttpRequest;e.open("GET",d,!1);e.responseType="arraybuffer";e.send(null);return new Uint8Array(e.response)});var O=function(d,e,k){var h=new XMLHttpRequest;h.open("GET",d,!0);h.responseType="arraybuffer";h.onload=function(){200==h.status||
0==h.status&&h.response?e(h.response):k()};h.onerror=k;h.send(null)}}a.print||console.log.bind(console);var z=a.printErr||console.warn.bind(console);for(r in C)C.hasOwnProperty(r)&&(a[r]=C[r]);C=null;var A;a.wasmBinary&&(A=a.wasmBinary);"object"!==typeof WebAssembly&&w("no native wasm support detected");var F,N=!1,M,G,K,S=[],P=[],R=[],v=0,L=null,D=null;a.preloadedImages={};a.preloadedAudios={};var m="libmikmodclib.wasm";m.startsWith("data:application/octet-stream;base64,")||(m=g(m));var T={a:function(d,
e,k){G.copyWithin(d,e,e+k)},b:function(d){var e=G.length;d>>>=0;if(33554432<d)return!1;for(var k=1;4>=k;k*=2){var h=e*(1+.2/k);h=Math.min(h,d+100663296);h=Math.min(33554432,f(Math.max(d,h),65536));a:{try{F.grow(h-M.byteLength+65535>>>16);n(F.buffer);var l=1;break a}catch(t){}l=void 0}if(l)return!0}return!1}};(function(){function d(l,t){a.asm=l.exports;F=a.asm.c;n(F.buffer);K=a.asm.e;P.unshift(a.asm.d);v--;a.monitorRunDependencies&&a.monitorRunDependencies(v);0==v&&(null!==L&&(clearInterval(L),L=null),
D&&(l=D,D=null,l()))}function e(l){d(l.instance)}function k(l){return y().then(function(t){return WebAssembly.instantiate(t,h)}).then(l,function(t){z("failed to asynchronously prepare wasm: "+t);w(t)})}var h={a:T};v++;a.monitorRunDependencies&&a.monitorRunDependencies(v);if(a.instantiateWasm)try{return a.instantiateWasm(h,d)}catch(l){return z("Module.instantiateWasm callback failed with error: "+l),!1}(function(){return A||"function"!==typeof WebAssembly.instantiateStreaming||m.startsWith("data:application/octet-stream;base64,")||
m.startsWith("file://")||"function"!==typeof fetch?k(e):fetch(m,{credentials:"same-origin"}).then(function(l){return WebAssembly.instantiateStreaming(l,h).then(e,function(t){z("wasm streaming compile failed: "+t);z("falling back to ArrayBuffer instantiation");return k(e)})})})().catch(H);return{}})();a.___wasm_call_ctors=function(){return(a.___wasm_call_ctors=a.asm.d).apply(null,arguments)};a._getAudioBuffer=function(){return(a._getAudioBuffer=a.asm.f).apply(null,arguments)};a._getAudioBufferMaxLength=
function(){return(a._getAudioBufferMaxLength=a.asm.g).apply(null,arguments)};a._getAudioBufferUsedLength=function(){return(a._getAudioBufferUsedLength=a.asm.h).apply(null,arguments)};a._getVersion=function(){return(a._getVersion=a.asm.i).apply(null,arguments)};a._init=function(){return(a._init=a.asm.j).apply(null,arguments)};a._freeModule=function(){return(a._freeModule=a.asm.k).apply(null,arguments)};a._terminate=function(){return(a._terminate=a.asm.l).apply(null,arguments)};a._preLoadModule=function(){return(a._preLoadModule=
a.asm.m).apply(null,arguments)};a._loadModule=function(){return(a._loadModule=a.asm.n).apply(null,arguments)};a._changeGeneralOptions=function(){return(a._changeGeneralOptions=a.asm.o).apply(null,arguments)};a._update=function(){return(a._update=a.asm.p).apply(null,arguments)};a._getErrno=function(){return(a._getErrno=a.asm.q).apply(null,arguments)};a._getStrerr=function(){return(a._getStrerr=a.asm.r).apply(null,arguments)};a._getSongName=function(){return(a._getSongName=a.asm.s).apply(null,arguments)};
a._getModType=function(){return(a._getModType=a.asm.t).apply(null,arguments)};a._getComment=function(){return(a._getComment=a.asm.u).apply(null,arguments)};var E;D=function e(){E||p();E||(D=e)};a.run=p;if(a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);0<a.preInit.length;)a.preInit.pop()();p();return c.ready}}();
"object"===typeof exports&&"object"===typeof module?module.exports=LibMikModCLib:"function"===typeof define&&define.amd?define([],function(){return LibMikModCLib}):"object"===typeof exports&&(exports.LibMikModCLib=LibMikModCLib);
