/*	MikMod Web Audio library v0.0.1
	(c) 2021 Carlos Rafael Gimenes das Neves.

	https://github.com/sezero/mikmod
	https://github.com/carlosrafaelgn/mikmod/tree/master/libmikmod/webaudio

	This library is free software; you can redistribute it and/or modify
	it under the terms of the GNU Library General Public License as
	published by the Free Software Foundation; either version 2 of
	the License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU Library General Public License for more details.

	You should have received a copy of the GNU Library General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
	02111-1307, USA.
*/
"use strict";var LibMikModMessageId;(function(b){b[b.INIT=1]="INIT";b[b.CHECK_STATUS=2]="CHECK_STATUS";b[b.LOAD_MODULE_BUFFER=3]="LOAD_MODULE_BUFFER";b[b.CHANGE_GENERAL_OPTIONS=4]="CHANGE_GENERAL_OPTIONS";b[b.STOP_MODULE=5]="STOP_MODULE";b[b.PLAYBACK_ERROR=6]="PLAYBACK_ERROR";b[b.PLAYBACK_ENDED=7]="PLAYBACK_ENDED";b[b.GET_ID=8]="GET_ID"})(LibMikModMessageId||(LibMikModMessageId={}));
class LibMikMod{static init(b){return LibMikMod.loaded?Promise.resolve():new Promise((d,f)=>{LibMikMod.loading?f("Still loading"):LibMikMod.loadError?f("Error loading the library"):(LibMikMod.loading=!0,LibMikModCLib({wasmBinary:b}).then(g=>{LibMikMod.cLib=g;(g=g._init())?(LibMikMod.loading=!1,LibMikMod.loadError=!0,f(g)):(LibMikMod.loading=!1,LibMikMod.loaded=!0,d())},g=>{LibMikMod.loading=!1;LibMikMod.loadError=!0;f(g)}))})}static terminate(){LibMikMod.cLib&&(LibMikMod.cLib._terminate(),LibMikMod.cLib=
null,LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static loadModule(b,d,f){if(!LibMikMod.cLib)return 3;if(!d)return 2;var g=LibMikMod.cLib._preLoadModule(d.byteLength);if(!g)return 2;g=new Uint8Array(LibMikMod.cLib.HEAP8.buffer,g,d.byteLength);"set"in d?g.set(d,0):g.set(new Uint8Array(d,0,d.byteLength),0);LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;f&&(void 0!==f.reverb&&0<=f.reverb&&15>=f.reverb&&(LibMikMod.lastReverb=f.reverb),void 0!==f.hqMixer&&(LibMikMod.lastHqMixer=
f.hqMixer?1:0),void 0!==f.interpolation&&(LibMikMod.lastInterpolation=f.interpolation?1:0),void 0!==f.noiseReduction&&(LibMikMod.lastNoiseReduction=f.noiseReduction?1:0),void 0!==f.wrap&&(LibMikMod.lastWrap=f.wrap?1:0),void 0!==f.loop&&(LibMikMod.lastLoop=f.loop?1:0),void 0!==f.fadeout&&(LibMikMod.lastFadeout=f.fadeout?1:0));return(b=LibMikMod.cLib._loadModule(b,LibMikMod.lastReverb,LibMikMod.lastHqMixer,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction,LibMikMod.lastWrap,LibMikMod.lastLoop,
LibMikMod.lastFadeout))||LibMikMod.cLib._getAudioBuffer()?b:2}static changeGeneralOptions(b){b&&(void 0!==b.reverb&&0<=b.reverb&&15>=b.reverb&&(LibMikMod.lastReverb=b.reverb),void 0!==b.interpolation&&(LibMikMod.lastInterpolation=b.interpolation?1:0),void 0!==b.noiseReduction&&(LibMikMod.lastNoiseReduction=b.noiseReduction?1:0),LibMikMod.cLib&&LibMikMod.cLib._changeGeneralOptions(LibMikMod.lastReverb,LibMikMod.lastInterpolation,LibMikMod.lastNoiseReduction))}static stopModule(){LibMikMod.cLib&&(LibMikMod.cLib._freeModule(),
LibMikMod.audioBufferPtr=0,LibMikMod.audioBufferUsedLength=0)}static getString(b,d){if(LibMikMod.cLib&&b){if(!d)return"";const f=Array(d),g=LibMikMod.cLib.HEAP8;for(;0<d--;)f[d]=g[b+d];return String.fromCharCode.apply(String,f)}return null}static getSongName(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getSongName(),LibMikMod.cLib._getSongNameLength()):null}static getModType(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getModType(),LibMikMod.cLib._getModTypeLength()):
null}static getComment(){return LibMikMod.cLib?LibMikMod.getString(LibMikMod.cLib._getComment(),LibMikMod.cLib._getCommentLength()):null}static getErrno(){return LibMikMod.cLib?LibMikMod.cLib._getErrno():0}static process(b){if(!LibMikMod.cLib)return!1;let d=LibMikMod.audioBufferUsedLength;if(!d){for(var f=0;3>f;f++){d=LibMikMod.cLib._update();if(0>d)return!1;if(d){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=d;break}}if(!d)return!0}var g=null;for(f=b.length-
1;0<=f;f--){const w=b[f];for(let x=w.length-1;0<=x;x--){const y=w[x];if(!g){var n=y.length<<2;if(d>=n)d=n,g=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,d>>2),LibMikMod.audioBufferPtr+=d,LibMikMod.audioBufferUsedLength-=d;else{LibMikMod.tmpBuffer&&LibMikMod.tmpBuffer.byteLength===n||(LibMikMod.tmpBuffer=new Float32Array(y.length));n=d>>2;g=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,n);LibMikMod.audioBufferPtr=0;d=LibMikMod.audioBufferUsedLength=
0;LibMikMod.tmpBuffer.set(g);let u=y.length-n;for(;0<u;){if(!d){for(g=0;3>g;g++){d=LibMikMod.cLib._update();if(0>d){if(LibMikMod.getErrno())return!1;d=0;break}if(d){LibMikMod.audioBufferPtr=LibMikMod.cLib._getAudioBuffer();LibMikMod.audioBufferUsedLength=d;break}}if(!d){LibMikMod.tmpBuffer.fill(0,n);break}}let p=u<<2;p>d&&(p=d);const a=p>>2;g=new Float32Array(LibMikMod.cLib.HEAP8.buffer,LibMikMod.audioBufferPtr,a);LibMikMod.audioBufferPtr+=p;LibMikMod.audioBufferUsedLength-=p;LibMikMod.tmpBuffer.set(g,
n);n+=a;u-=a}g=LibMikMod.tmpBuffer}}y.set(g)}}return!0}}LibMikMod.cLib=null;LibMikMod.tmpBuffer=null;LibMikMod.audioBufferPtr=0;LibMikMod.audioBufferUsedLength=0;LibMikMod.lastReverb=0;LibMikMod.lastHqMixer=1;LibMikMod.lastInterpolation=1;LibMikMod.lastNoiseReduction=1;LibMikMod.lastWrap=0;LibMikMod.lastLoop=0;LibMikMod.lastFadeout=1;LibMikMod.loading=!1;LibMikMod.loaded=!1;LibMikMod.loadError=!1;
class LibMikModProcessor extends AudioWorkletProcessor{constructor(){super();this.ended=!1;this.id=++LibMikModProcessor.currentId;this.port.onmessage=this.handleMessage.bind(this)}postResponse(b){this.id==LibMikModProcessor.currentId&&this.port.postMessage(b)}handleMessage(b){if(b=b.data)switch(b.messageId){case LibMikModMessageId.INIT:LibMikMod.loaded||LibMikMod.loading||LibMikMod.loadError||!b.buffer||LibMikMod.init(b.buffer).then(()=>{this.postResponse({id:this.id,messageId:LibMikModMessageId.INIT})},
()=>{this.postResponse({id:this.id,messageId:LibMikModMessageId.INIT})});break;case LibMikModMessageId.CHECK_STATUS:b.id===this.id&&this.postResponse({id:this.id,messageId:LibMikModMessageId.CHECK_STATUS,loading:LibMikMod.loading,loaded:LibMikMod.loaded,loadError:LibMikMod.loadError});break;case LibMikModMessageId.LOAD_MODULE_BUFFER:b.id===this.id&&((b=LibMikMod.loadModule(sampleRate,b.buffer,b.options))?this.postResponse({id:this.id,messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,result:b}):this.postResponse({id:this.id,
messageId:LibMikModMessageId.LOAD_MODULE_BUFFER,result:b,infoSongName:LibMikMod.getSongName(),infoModType:LibMikMod.getModType(),infoComment:LibMikMod.getComment()}));break;case LibMikModMessageId.CHANGE_GENERAL_OPTIONS:LibMikMod.changeGeneralOptions(b.options);break;case LibMikModMessageId.STOP_MODULE:b.id!==this.id||this.ended||(this.ended=!0,LibMikMod.stopModule());break;case LibMikModMessageId.GET_ID:this.postResponse({id:this.id,messageId:LibMikModMessageId.GET_ID})}}process(b,d,f){return this.id!=
LibMikModProcessor.currentId||this.ended?!1:LibMikMod.process(d)?!0:(this.ended||(this.ended=!0,LibMikMod.stopModule(),this.postResponse({id:this.id,messageId:LibMikMod.getErrno()?LibMikModMessageId.PLAYBACK_ERROR:LibMikModMessageId.PLAYBACK_ENDED,result:LibMikMod.getErrno()})),!1)}}LibMikModProcessor.currentId=0;registerProcessor("libmikmodprocessor",LibMikModProcessor);
var LibMikModCLib=function(){var b="undefined"!==typeof document&&document.currentScript?document.currentScript.src:void 0;return function(d){function f(c){return a.locateFile?a.locateFile(c,q):q+c}function g(c,e){0<c%e&&(c+=e-c%e);return c}function n(c){M=c;a.HEAP8=new Int8Array(c);a.HEAP16=new Int16Array(c);a.HEAP32=new Int32Array(c);a.HEAPU8=G=new Uint8Array(c);a.HEAPU16=new Uint16Array(c);a.HEAPU32=new Uint32Array(c);a.HEAPF32=new Float32Array(c);a.HEAPF64=new Float64Array(c)}function w(c){if(a.onAbort)a.onAbort(c);
c+="";z(c);N=!0;c=new WebAssembly.RuntimeError("abort("+c+"). Build with -s ASSERTIONS=1 for more info.");H(c);throw c;}function x(c){try{if(c==m&&A)return new Uint8Array(A);if(I)return I(c);throw"both async and sync fetching of the wasm failed";}catch(e){w(e)}}function y(){if(!A&&(J||B)){if("function"===typeof fetch&&!m.startsWith("file://"))return fetch(m,{credentials:"same-origin"}).then(function(c){if(!c.ok)throw"failed to load wasm binary file at '"+m+"'";return c.arrayBuffer()}).catch(function(){return x(m)});
if(O)return new Promise(function(c,e){O(m,function(k){c(new Uint8Array(k))},e)})}return Promise.resolve().then(function(){return x(m)})}function u(c){for(;0<c.length;){var e=c.shift();if("function"==typeof e)e(a);else{var k=e.func;"number"===typeof k?void 0===e.arg?K.get(k)():K.get(k)(e.arg):k(void 0===e.arg?null:e.arg)}}}function p(c){function e(){if(!E&&(E=!0,a.calledRun=!0,!N)){u(P);Q(a);if(a.onRuntimeInitialized)a.onRuntimeInitialized();if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=
[a.postRun]);a.postRun.length;)R.unshift(a.postRun.shift());u(R)}}if(!(0<v)){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)S.unshift(a.preRun.shift());u(S);0<v||(a.setStatus?(a.setStatus("Running..."),setTimeout(function(){setTimeout(function(){a.setStatus("")},1);e()},1)):e())}}d=d||{};var a="undefined"!==typeof d?d:{},Q,H;a.ready=new Promise(function(c,e){Q=c;H=e});var C={},r;for(r in a)a.hasOwnProperty(r)&&(C[r]=a[r]);var J=!1,B=!1;J="object"===typeof window;
B="function"===typeof importScripts;var q="",I;if(J||B){B?q=self.location.href:"undefined"!==typeof document&&document.currentScript&&(q=document.currentScript.src);b&&(q=b);q=0!==q.indexOf("blob:")?q.substr(0,q.lastIndexOf("/")+1):"";B&&(I=function(c){var e=new XMLHttpRequest;e.open("GET",c,!1);e.responseType="arraybuffer";e.send(null);return new Uint8Array(e.response)});var O=function(c,e,k){var h=new XMLHttpRequest;h.open("GET",c,!0);h.responseType="arraybuffer";h.onload=function(){200==h.status||
0==h.status&&h.response?e(h.response):k()};h.onerror=k;h.send(null)}}a.print||console.log.bind(console);var z=a.printErr||console.warn.bind(console);for(r in C)C.hasOwnProperty(r)&&(a[r]=C[r]);C=null;var A;a.wasmBinary&&(A=a.wasmBinary);"object"!==typeof WebAssembly&&w("no native wasm support detected");var F,N=!1,M,G,K,S=[],P=[],R=[],v=0,L=null,D=null;a.preloadedImages={};a.preloadedAudios={};var m="libmikmodclib.wasm";m.startsWith("data:application/octet-stream;base64,")||(m=f(m));var T={a:function(c,
e,k){G.copyWithin(c,e,e+k)},b:function(c){var e=G.length;c>>>=0;if(33554432<c)return!1;for(var k=1;4>=k;k*=2){var h=e*(1+.2/k);h=Math.min(h,c+100663296);h=Math.min(33554432,g(Math.max(c,h),65536));a:{try{F.grow(h-M.byteLength+65535>>>16);n(F.buffer);var l=1;break a}catch(t){}l=void 0}if(l)return!0}return!1}};(function(){function c(l,t){a.asm=l.exports;F=a.asm.c;n(F.buffer);K=a.asm.e;P.unshift(a.asm.d);v--;a.monitorRunDependencies&&a.monitorRunDependencies(v);0==v&&(null!==L&&(clearInterval(L),L=null),
D&&(l=D,D=null,l()))}function e(l){c(l.instance)}function k(l){return y().then(function(t){return WebAssembly.instantiate(t,h)}).then(l,function(t){z("failed to asynchronously prepare wasm: "+t);w(t)})}var h={a:T};v++;a.monitorRunDependencies&&a.monitorRunDependencies(v);if(a.instantiateWasm)try{return a.instantiateWasm(h,c)}catch(l){return z("Module.instantiateWasm callback failed with error: "+l),!1}(function(){return A||"function"!==typeof WebAssembly.instantiateStreaming||m.startsWith("data:application/octet-stream;base64,")||
m.startsWith("file://")||"function"!==typeof fetch?k(e):fetch(m,{credentials:"same-origin"}).then(function(l){return WebAssembly.instantiateStreaming(l,h).then(e,function(t){z("wasm streaming compile failed: "+t);z("falling back to ArrayBuffer instantiation");return k(e)})})})().catch(H);return{}})();a.___wasm_call_ctors=function(){return(a.___wasm_call_ctors=a.asm.d).apply(null,arguments)};a._getAudioBuffer=function(){return(a._getAudioBuffer=a.asm.f).apply(null,arguments)};a._getAudioBufferMaxLength=
function(){return(a._getAudioBufferMaxLength=a.asm.g).apply(null,arguments)};a._getAudioBufferUsedLength=function(){return(a._getAudioBufferUsedLength=a.asm.h).apply(null,arguments)};a._init=function(){return(a._init=a.asm.i).apply(null,arguments)};a._freeModule=function(){return(a._freeModule=a.asm.j).apply(null,arguments)};a._terminate=function(){return(a._terminate=a.asm.k).apply(null,arguments)};a._preLoadModule=function(){return(a._preLoadModule=a.asm.l).apply(null,arguments)};a._loadModule=
function(){return(a._loadModule=a.asm.m).apply(null,arguments)};a._changeGeneralOptions=function(){return(a._changeGeneralOptions=a.asm.n).apply(null,arguments)};a._update=function(){return(a._update=a.asm.o).apply(null,arguments)};a._getErrno=function(){return(a._getErrno=a.asm.p).apply(null,arguments)};a._getSongName=function(){return(a._getSongName=a.asm.q).apply(null,arguments)};a._getSongNameLength=function(){return(a._getSongNameLength=a.asm.r).apply(null,arguments)};a._getModType=function(){return(a._getModType=
a.asm.s).apply(null,arguments)};a._getModTypeLength=function(){return(a._getModTypeLength=a.asm.t).apply(null,arguments)};a._getComment=function(){return(a._getComment=a.asm.u).apply(null,arguments)};a._getCommentLength=function(){return(a._getCommentLength=a.asm.v).apply(null,arguments)};var E;D=function e(){E||p();E||(D=e)};a.run=p;if(a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);0<a.preInit.length;)a.preInit.pop()();p();return d.ready}}();
"object"===typeof exports&&"object"===typeof module?module.exports=LibMikModCLib:"function"===typeof define&&define.amd?define([],function(){return LibMikModCLib}):"object"===typeof exports&&(exports.LibMikModCLib=LibMikModCLib);
