<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>LibMikMod Web Audio Example</title>

	<style type="text/css">
		body {
			font-family: sans-serif;
		}
	</style>
</head>
<body>
	<noscript>Sorry! You need to enable JavaScript in order to run the example :(</noscript>

	<h1>
		LibMikMod Web Audio Example
	</h1>

	<p>
		<label for="inputModuleFile">Module file (669, amf, asy, dsm, far, gdm, gt2, imf, it, m15, med, mod, mtm, okt, s3m, stm, stx, ult, umx, uni, xm)</label>
		<br />
		<input type="file" id="inputModuleFile" accept=".669,.amf,.asy,.dsm,.far,.gdm,.gt2,.imf,.it,.m15,.med,.mod,.mtm,.okt,.s3m,.stm,.stx,.ult,.umx,.uni,.xm" />
	</p>

	<p>
		<button type="button" onclick="load()">(Re)Load module file</button>
	</p>

	<p>
		<button type="button" onclick="play()" id="buttonPlay" disabled>Play</button>
		<button type="button" onclick="pause()" id="buttonPause" disabled>Pause</button>
	</p>

	<h2>
		Song information
	</h2>

	<pre id="songInfo"></pre>

	<script type="text/javascript" src="dist/libmikmodaudionode.min.js"></script>
	<script type="text/javascript">
		//<![CDATA[
		"use strict";

		// According to Can I Use, we can assume that if a browser supports AudioWorkletNode it
		// also supports WebAssembly (but not the other way around).
		// Promises, ES6 and all other dependencies are also present in a browser which
		// supports these two features:
		// https://caniuse.com/wasm
		// https://caniuse.com/mdn-api_audioworkletnode
		if (!LibMikModAudioNode.isSupported())
			alert("Sorry, but your browser does not meet the minimum requirements :(");

		var inputModuleFile = document.getElementById("inputModuleFile"),
			buttonPlay = document.getElementById("buttonPlay"),
			buttonPause = document.getElementById("buttonPause"),
			songInfo = document.getElementById("songInfo"),
			fileLoading = false,
			fileLoaded = false,
			audioNode = null,
			audioContext = new AudioContext();

		function load() {
			if (fileLoading || LibMikModAudioNode.loading)
				return;

			if (!inputModuleFile.files || !inputModuleFile.files.length) {
				alert("Please, select a file first");
				return;
			}

			if (!LibMikModAudioNode.initialized) {
				LibMikModAudioNode.init(audioContext, "dist/").then(load, function (reason) {
					alert("Error loading LibMikModAudioNode: " + reason);
				});
				return;
			}

			LibMikModAudioNode.stopModule();

			buttonPlay.setAttribute("disabled", "disabled");
			buttonPause.setAttribute("disabled", "disabled");
			fileLoaded = false;
			audioContext.suspend();
			if (audioNode)
				audioNode.disconnect();

			fileLoading = true;

			var reader = new FileReader();
			reader.onerror = function () {
				fileLoading = false;
				alert("Error loading the file");
			};
			reader.onload = function () {
				LibMikModAudioNode.loadModule(audioContext, reader.result, moduleOnload, moduleOnerror, moduleOnended);
			};
			reader.readAsArrayBuffer(inputModuleFile.files[0]);
		}

		function play() {
			if (fileLoaded)
				audioContext.resume();
		}

		function pause() {
			if (fileLoaded)
				audioContext.suspend();
		}

		function moduleOnload(newAudioNode) {
			songInfo.textContent =
				"Song name: " + LibMikModAudioNode.infoSongName + "\n" +
				"Module type: " + LibMikModAudioNode.infoModType + "\n" +
				"Comment: " + LibMikModAudioNode.infoComment
			;

			fileLoading = false;
			newAudioNode.connect(audioContext.destination);
			audioNode = newAudioNode;
			buttonPlay.removeAttribute("disabled");
			buttonPause.removeAttribute("disabled");
			fileLoaded = true;
			audioContext.resume();
		}

		function moduleOnerror(reason) {
			songInfo.textContent = "";

			if (fileLoading) {
				fileLoading = false;
				alert("Error loading the module: " + reason);
			} else {
				alert("Error during module playback: " + reason);
			}
		}

		function moduleOnended() {
			audioContext.suspend();
			alert("Playback ended!");
		}

		//]]>
	</script>
</body>
</html>
